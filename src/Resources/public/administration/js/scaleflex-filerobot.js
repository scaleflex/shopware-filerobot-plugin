(function(){var e={117:function(){let e=Shopware.Classes.ApiService,{Application:t}=Shopware;class i extends e{constructor(e,t,i="filerobot-api-test"){super(e,t,i)}check(t){let i=this.getBasicHeaders({});return this.httpClient.post(`_action/${this.getApiBasePath()}/verify`,t,{headers:i}).then(t=>e.handleResponse(t))}}t.addServiceProvider("filerobotApiTest",e=>new i(t.getContainer("init").httpClient,e.loginService))}},t={};function i(o){var r=t[o];if(void 0!==r)return r.exports;var n=t[o]={exports:{}};return e[o](n,n.exports,i),n.exports}i.p="bundles/scaleflexfilerobot/",window?.__sw__?.assetPath&&(i.p=window.__sw__.assetPath+"/bundles/scaleflexfilerobot/"),function(){"use strict";let{Component:e,Mixin:t,Context:o}=Shopware,{fileReader:r}=Shopware.Utils;e.register("sw-filerobot-library",{template:'<div class="sw-filerobot-library" style="overflow: scroll">\r\n    <div id="filerobot-widget"></div>\r\n</div>\r\n',inject:["systemConfigApiService","repositoryFactory","mediaService"],model:{prop:"selection",event:"media-selection-change"},mixins:[t.getByName("notification"),t.getByName("media-grid-listener")],props:{frActivation:{type:Boolean,required:!1,default:!1},frToken:{type:String,required:!1,default:null},frSEC:{type:String,required:!1,default:null},frUploadDirectory:{type:String,required:!1,default:null},frSass:{type:String,required:!1,default:null},frCNAME:{type:String,required:!1,default:null},frFolderId:{type:String,required:!1,default:null},selection:{type:Array,required:!0},uploadTag:{type:String,required:!0},disabled:{type:Boolean,required:!1,default:!1},frAdminAccessKeyID:{type:String,required:!1,default:null},frAdminSecretAccessKey:{type:String,required:!1,default:null},adminAuthToken:{type:String,required:!1,default:null}},data(){return{selectedItems:this.selection}},mounted(){let e=document.createElement("script");e.setAttribute("src","https://cdn.scaleflex.com/plugins/filerobot-widget/v3/latest/filerobot-widget.min.js"),e.setAttribute("async","true"),document.head.appendChild(e);let t=document.createElement("script");t.innerHTML="delete Filerobot",document.head.appendChild(t)},computed:{mediaRepository(){return this.repositoryFactory.create("media")},isUrlUpload(){return"url-upload"===this.inputType}},watch:{selection(){this.selectedItems=this.selection,null===this.listSelectionStartItem||this.selectedItems.includes(this.listSelectionStartItem)||(this.listSelectionStartItem=this.selectedItems[0]||null)},selectedItems(){this.$emit("media-selection-change",this.selectedItems)}},created(){this.createdComponent()},beforeDestroy(){this.beforeDestroyComponent()},methods:{useFileUpload(){this.inputType="file-upload"},async createdComponent(){let e=await this.systemConfigApiService.getValues("ScaleflexFilerobot.config"),t=e["ScaleflexFilerobot.config.frActivation"],i=e["ScaleflexFilerobot.config.frSEC"],o=e["ScaleflexFilerobot.config.frToken"];if(!0===t&&""!==o&&""!==i){this.mediaService.addListener(this.uploadTag,this.handleMediaServiceUploadEvent),document.getElementsByClassName("sw-media-sidebar no-headline")[0].style.display="none",document.getElementsByClassName("sw-modal__footer")[0].style.display="none",await this.waitFilerobotLibrary();let t=window.Filerobot,r=null;r=t.Core({securityTemplateID:i,container:o}),this.renderWidget(r,e)}else this.createNotificationError({title:this.$tc("global.default.error"),message:this.$tc("frErrors.unauthorized")})},sleep(e){return new Promise(t=>setTimeout(t,e))},beforeDestroyComponent(){this.mediaService.removeByTag(this.uploadTag),this.mediaService.removeListener(this.uploadTag,this.handleMediaServiceUploadEvent)},getMediaEntityForUpload(e){let t=this.mediaRepository.create();return t.mediaFolderId=e,t},async onUrlUpload({url:e,fileExtension:t,frFolderId:i}){let n;try{n=r.getNameAndExtensionFromUrl(e)}catch{this.createNotificationError({title:this.$tc("global.default.error"),message:this.$tc("global.sw-media-upload-v2.notification.invalidUrl.message")});return}t&&(n.extension=t);let l=this.getMediaEntityForUpload(i);return await this.mediaRepository.save(l,o.api),await this.mediaService.addUpload(this.uploadTag,{src:e,filerobot:!0,targetId:l.id,...n}),this.useFileUpload(),l.id},handleMediaServiceUploadEvent({action:e}){"media-upload-fail"===e&&this.onRemoveMediaItem()},onRemoveMediaItem(){this.disabled||(this.preview=null,this.$emit("media-upload-remove-image"))},waitFilerobotLibrary(){return new Promise(function(e,t){let i=!1;for(;!i;)void 0!==window.Filerobot&&(i=!0,e(!0))})},renderWidget(e,t){let i=t["ScaleflexFilerobot.config.frCNAME"],r=t["ScaleflexFilerobot.config.frUploadDirectory"],n=t["ScaleflexFilerobot.config.frAdminAccessKeyID"],l=t["ScaleflexFilerobot.config.frAdminSecretAccessKey"],a=t["ScaleflexFilerobot.config.frFolderId"],s=Filerobot.Explorer,d=Filerobot.XHRUpload,c=Filerobot.ImageEditor;e.use(s,{config:{rootFolderPath:r},target:"#filerobot-widget",inline:!0,width:"100%",height:1e3,disableExportButton:!1,hideExportButtonIcon:!0,preventExportDefaultBehavior:!0,dismissUrlPathQueryUpdate:!0,disableDownloadButton:!1,hideDownloadButtonIcon:!0,preventDownloadDefaultBehavior:!0,locale:{strings:{mutualizedExportButtonLabel:this.$tc("frWidgetLocale.button.export"),mutualizedDownloadButton:this.$tc("frWidgetLocale.button.export")}}}).use(d).use(c).on("export",async(e,t,r,s)=>{let d=window.location.href.split("admin#")[0];await fetch(d+"api/oauth/token",{method:"POST",timeout:30,headers:{"Content-Type":"application/json; charset=utf-8"},body:JSON.stringify({client_id:n,client_secret:l,grant_type:"client_credentials"})}).then(e=>e.json()).then(async t=>{let r=null;if(void 0!==t.access_token&&""!==t.access_token&&(r=t.access_token),null!==r){let t,n=document.getElementsByClassName("SfxButton-root");for(let e=0;e<n.length;e++)n[e].setAttribute("disabled","true");let l=this.$tc("frWidgetLocale.button.processing"),s=document.getElementsByClassName("filerobot-Explorer-TopBar-DownloadWithExportButton-downloadButton");for(let e=0;e<s.length;e++)t=s[e].innerHTML,s[e].setAttribute("disabled","true"),s[e].innerHTML=l;let c=[];for(let l of e){let e=d+"api/scaleflex/filerobot/check-filerobot-uuid-exist";await fetch(e,{method:"POST",timeout:30,headers:{"Content-Type":"application/json; charset=utf-8",Authorization:"Bearer "+r},body:JSON.stringify({filerobot_uuid:l.file.uuid})}).then(e=>e.json()).then(async e=>{let t=null;if(!1!==e){let t=e[0].id,i=await this.mediaRepository.get(t,o.api);this.selection.push(i)}else{let e=new URL(l.link),r=l.file.extension,n=await this.onUrlUpload({url:e,fileExtension:r,frFolderId:a}),s=!1;for(;!s;)if(await this.sleep(1e3),null!==(t=await this.mediaRepository.get(n,o.api)).uploadedAt){s=!0;let e=t.url.replace(d,""),o=l.file.url.cdn,r=new URL(o);r.searchParams.has("vh")&&r.searchParams.delete("vh"),""!==i&&null!==i&&(r.host=i,r.hostname=i),c.push({media_id:n,filerobot_url:o,filerobot_uuid:l.file.uuid,media_path:"/"+e}),0===this.selection.length&&this.selection.push(t),this.selection[this.selection.length-1].url=l.file.url.cdn,this.selectedItems=this.selection}}}).catch(e=>{this.createNotificationError({title:this.$tc("global.default.error"),message:this.$tc("frErrors.addMedia")}),console.error("Error:",e);for(let e=0;e<n.length;e++)n[e].removeAttribute("disabled");for(let e=0;e<s.length;e++)s[e].removeAttribute("disabled"),s[e].innerHTML=t})}if(document.querySelector(".sw-modal.sw-media-modal-v2.sw-modal--full").querySelector(".sw-button.sw-button--primary").click(),this.$emit("media-selection-change",this.selectedItems),await this.sleep(1e3),c.length)for(let e=0;e<c.length;e++){let i=d+"api/scaleflex/filerobot/clean-up-media";fetch(i,{method:"POST",timeout:30,headers:{"Content-Type":"application/json; charset=utf-8",Authorization:"Bearer "+r},body:JSON.stringify(c[e])}).then(e=>e.json()).then(e=>{if(!e){this.createNotificationError({title:this.$tc("global.default.error"),message:this.$tc("frErrors.cleanMediaFail")});for(let e=0;e<n.length;e++)n[e].removeAttribute("disabled");for(let e=0;e<s.length;e++)s[e].removeAttribute("disabled"),s[e].innerHTML=t}}).catch(e=>{this.createNotificationError({title:this.$tc("global.default.error"),message:this.$tc("frErrors.cleanMediaFail")}),console.error("Error:",e);for(let e=0;e<n.length;e++)n[e].removeAttribute("disabled");for(let e=0;e<s.length;e++)s[e].removeAttribute("disabled"),s[e].innerHTML=t})}}else this.createNotificationError({title:this.$tc("global.default.error"),message:this.$tc("frErrors.adminAuthToken")})}).catch(e=>{this.createNotificationError({title:this.$tc("global.default.error"),message:this.$tc("frErrors.adminAuthToken")}),console.error("Error:",e)})}).on("complete",({failed:e,uploadID:t,successful:i})=>{e&&console.dir(e),i&&i.forEach((e,t)=>{})})}}}),Shopware.Component.override("sw-media-modal-v2",{template:'{% block sw_media_modal_v2_tab_items %}\r\n    {% parent %}\r\n    <sw-tabs-item\r\n            :name="tabFilerobotDAM"\r\n            :active-tab="active"\r\n    >\r\n        Filerobot DAM\r\n    </sw-tabs-item>\r\n{% endblock %}\r\n\r\n{% block sw_media_modal_v2_tab_content_library %}\r\n    {% parent %}\r\n    <template v-if="active === tabFilerobotDAM">\r\n        {% block sw_filerobot_modal_media_library %}\r\n            <sw-upload-listener\r\n                    :upload-tag="uploadTag"\r\n                    @media-upload-add="onUploadsAdded"\r\n                    @media-upload-finish="onUploadFinished"\r\n                    @media-upload-fail="onUploadFailed"\r\n            />\r\n\r\n            <sw-filerobot-library\r\n                    ref="filerobotLibrary"\r\n                    :selection="selection"\r\n                    :upload-tag="uploadTag"\r\n                    @media-selection-change="selection = $event"/>\r\n        {% endblock %}\r\n    </template>\r\n{% endblock %}\r\n',inject:["systemConfigApiService"],props:{defaultTab:{type:String,required:!1,validValues:["upload","library","filerobot"],validator(e){return["upload","library","filerobot"].includes(e)}}},computed:{tabFilerobotDAM(){return"filerobot"}}});let{Component:n}=Shopware;n.register("sw-filerobot-index",{template:'\r\n{% block sw_filerobot_index %}\r\n    <sw-page class="sw-filerobot-index">\r\n        {% block sw_filerobot_index_page_content %}\r\n            <template slot="content">\r\n                <div class="sw-filerobot-library" style="overflow: scroll">\r\n                    <div id="filerobot-widget"></div>\r\n                </div>\r\n            </template>\r\n        {% endblock %}\r\n    </sw-page>\r\n{% endblock %}\r\n',inject:["systemConfigApiService","repositoryFactory","mediaService"],props:{selection:{type:Array,required:!0}},data(){return{isLoading:!1,term:this.$route.query?this.$route.query.term:""}},mounted(){let e=document.createElement("script");e.setAttribute("src","https://cdn.scaleflex.com/plugins/filerobot-widget/v3/latest/filerobot-widget.min.js"),e.setAttribute("async","true"),document.head.appendChild(e);let t=document.createElement("script");t.innerHTML="delete Filerobot",document.head.appendChild(t)},metaInfo(){return{title:this.$createTitle()}},created(){this.createdComponent()},methods:{async createdComponent(){let e=await this.systemConfigApiService.getValues("ScaleflexFilerobot.config"),t=e["ScaleflexFilerobot.config.frActivation"],i=e["ScaleflexFilerobot.config.frSEC"],o=e["ScaleflexFilerobot.config.frToken"];if(!0===t&&""!==o&&""!==i){this.mediaService.addListener(this.uploadTag,this.handleMediaServiceUploadEvent),await this.waitFilerobotLibrary();let t=window.Filerobot,r=null;r=t.Core({securityTemplateID:i,container:o}),this.renderWidget(r,e)}else this.createNotificationError({title:this.$tc("global.default.error"),message:this.$tc("frErrors.unauthorized")})},sleep(e){return new Promise(t=>setTimeout(t,e))},waitFilerobotLibrary(){return new Promise(function(e,t){let i=!1;for(;!i;)void 0!==window.Filerobot&&(i=!0,e(!0))})},renderWidget(e,t){let i=t["ScaleflexFilerobot.config.frUploadDirectory"],o=Filerobot.Explorer,r=Filerobot.XHRUpload,n=Filerobot.ImageEditor;e.use(o,{config:{rootFolderPath:i},target:"#filerobot-widget",inline:!0,width:"100%",height:1e3,disableExportButton:!1,hideExportButtonIcon:!0,preventExportDefaultBehavior:!0,dismissUrlPathQueryUpdate:!0,disableDownloadButton:!1,hideDownloadButtonIcon:!0,preventDownloadDefaultBehavior:!0,locale:{strings:{mutualizedExportButtonLabel:this.$tc("frWidgetLocale.button.export"),mutualizedDownloadButton:this.$tc("frWidgetLocale.button.export")}}}).use(r).use(n).on("export",async(e,t,i,o)=>{}).on("complete",({failed:e,uploadID:t,successful:i})=>{})}}}),Shopware.Module.register("sw-filerobot",{name:"filerobot",title:"sw-filerobot.general.mainMenuItemGeneral",description:"sw-filerobot.general.descriptionTextModule",favicon:"icon-module-content.png",color:"#ff68b4",icon:"regular-image",routes:{index:{components:{default:"sw-filerobot-index"},path:"index"}},navigation:[{id:"sw-filerobot",label:"sw-filerobot.general.mainMenuItemGeneral",color:"#ff3d58",path:"sw.filerobot.index",icon:"regular-image",parent:"sw-content",position:30}]}),i(117);let{Component:l,Mixin:a}=Shopware;l.register("filerobot-api-test-button",{template:'<div>\r\n    <sw-button-process\r\n        :isLoading="isLoading"\r\n        :processSuccess="isSaveSuccessful"\r\n        @process-finish="saveFinish"\r\n        @click="check"\r\n    >{{ $tc(\'filerobot-api-test-button.button\') }}</sw-button-process>\r\n</div>\r\n',props:["label"],inject:["filerobotApiTest"],mixins:[a.getByName("notification")],data(){return{isLoading:!1,isSaveSuccessful:!1}},computed:{pluginConfig(){let e=this.$parent;for(;void 0===e.actualConfigData;)e=e.$parent;return e.actualConfigData.null}},methods:{saveFinish(){this.isSaveSuccessful=!1},check(){this.isLoading=!0,this.filerobotApiTest.check(this.pluginConfig).then(e=>{e.success?(this.isSaveSuccessful=!0,this.createNotificationSuccess({title:this.$tc("filerobot-api-test-button.title"),message:this.$tc("filerobot-api-test-button.success")})):this.createNotificationError({title:this.$tc("filerobot-api-test-button.title"),message:this.$tc("filerobot-api-test-button.errors."+e.message)}),this.isLoading=!1})}}});var s=JSON.parse('{"filerobot-api-test-button":{"title":"Testverbindung von/zu Filerobot","success":"Verbindung wurde erfolgreich getestet.","errors":{"failToVerifyFilerobotToken":"Die Verbindung konnte nicht hergestellt werden. Bitte \xfcberpr\xfcfen Sie Filerobot Token und Security Template Identifier.","failToVerifyAdminAuthToken":"Verbindung konnte nicht hergestellt werden. Bitte \xfcberpr\xfcfen Sie Admin-Zugriffsschl\xfcssel-ID und geheimen Admin-Zugriffsschl\xfcssel."},"button":"Verbindung wird getestet"},"frWidgetLocale":{"locale":"DE","button":{"export":"Exportieren","processing":"Wird bearbeitet"}},"frErrors":{"unauthorized":"Filerobot ist nicht autorisiert.","failedToGetKey":"Filerobot konnte keinen Schl\xfcssel abrufen.","tokenOrSEC":"Filerobot-Token oder Security Tamplate ist leer. Bitte \xfcberpr\xfcfen Sie erneut die Einstellung des Plugins.","notActive":"Filerobot ist nicht aktiv. Bitte \xfcberpr\xfcfen Sie erneut die Einstellung des Plugins.","cleanMediaFail":"Die Bereinigung der Medien is fehlgeschlagen.","adminAuthToken":"Admin-Authentifizierungstoken kann nicht abgerufen werden. Bitte \xfcberpr\xfcfen Sie erneut die Einstellung des Plugina.","addMedia":"Das Einlegen des Mediums ist fehlgeschlagen."}}'),d=JSON.parse('{"filerobot-api-test-button":{"title":"Filerobot test connection","success":"Connection was successfully tested.","errors":{"failToVerifyFilerobotToken":"Connection could not be established. Please check again Filerobot Token and Security Template Identifier.","failToVerifyAdminAuthToken":"Connection could not be established. Please check again Admin access key ID and Admin secret access key."},"button":"Test connection"},"frWidgetLocale":{"locale":"EN","button":{"export":"Export","processing":"Processing"}},"frErrors":{"unauthorized":"Filerobot is unauthorized.","failedToGetKey":"Filerobot has failed to get key.","tokenOrSEC":"Filerobot token or Security template identifier is empty. Please check again your plugin configuration.","notActive":"Filerobot is not active. Please check again your plugin configuration.","cleanMediaFail":"Clean up media had failed.","adminAuthToken":"Can\'t get admin auth token. Please check again your plugin configuration.","addMedia":"Insert media has been failed."}}');Shopware.Locale.extend("de-DE",s),Shopware.Locale.extend("en-GB",d)}()})();